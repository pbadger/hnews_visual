<!DOCTYPE html>
<html>
  <head>
    <title>A Snapshot of Hacker News</title>
  </head>

  <body>
	<h1><center>A Snapshot of Hacker News</center></h1>

	<textarea class="csv" id="monday_csv"> 
		<%= render 'brians_csv' %>
	</textarea>

	<div class="keyword_explanation">
		This bar graph shows the frequency of the most common keywords across articles. These are simply the most common words, aggregated from all articles, with common <a href="http://en.wikipedia.org/wiki/Stop_word">'stop words'</a> filtered out.
	</div>


  <div class="modal hide fade" id='video_modal'>
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h2>Whats going on here?</h2>
    </div>
    <div class="modal-body">
      <object width="420" height="315"><param name="movie" value="http://www.youtube.com/v/BNAUi9e4RRg?version=3&amp;hl=en_US"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/BNAUi9e4RRg?version=3&amp;hl=en_US" type="application/x-shockwave-flash" width="504" height="378" allowscriptaccess="always" allowfullscreen="true"></embed></object>
    </div>
    <div class="modal-footer">
      <a href="#" class="btn btn-primary" data-toggle="modal" data-target="#video_modal">Lemme see it!</a>
    </div>
  </div>

  <div class="tooltip" id="scatter_tt">
    <div class="tt_title">
    </div>
    <div class="tt_points">
    </div>
  </div>

	<script>
    if (document.cookie != 'seen_video')
    {
      $('#video_modal').modal('show');
      document.cookie = 'seen_video';
    }

		var parseDate = d3.time.format("%d %m %H:%M").parse;
		var color = d3.scale.category10();
		color.domain(["monday","tuesday","wednesday","thursday"]);

		var legend = d3.select("body").append("div")
			.attr("id", "side");

		var sums = new Array();
		var data = ""; 
		color.domain().forEach(function(d) {
			legend.append("p").text(d)
				.style("color", color(d));
			data = document.getElementById(d+"_csv").value;
			data = data.split("\n");
			data.splice(0,2);
			data.splice(-1,1);
			
			data.forEach(function(d) {
				var date = parseDate(d.split(",")[3]);
				
				if(date != null) {
					if(sums[date] == null) {
						sums[date] = sums.length;
						sums.push([date.getHours(),1]);
					} else {
						sums[sums[date]][1] += 1;
					}
				}
			});
		});
			
		var days = new Array(color.domain().length);
		for(var i=0; i < days.length; i++) {
			days[i] = sums.splice(0,24);
		}

		var margin = {top: 20, right: 20, bottom: 30, left: 50},
			width = 850 - margin.left - margin.right,
			height = 450 - margin.top - margin.bottom;

		var axis_x = d3.time.scale()
			.range([0, width])
			.domain([new Date(2012,2,2),new Date(2012,2,2,23)]);

		var line_x = d3.time.scale()
			.range([0, width])
			.domain(d3.extent(days[1], function(d) { return d[0]; }));


		var y = d3.scale.linear()
			.range([height, 0])
			.domain([
				d3.min(days, function(c) { return d3.min(c, function(v) { return v[1]; }); }),
				d3.max(days, function(c) { return d3.max(c, function(v) { return v[1]; }); })
			]);

		var xAxis = d3.svg.axis()
			.scale(axis_x)
			.orient("bottom");

		var yAxis = d3.svg.axis()
			.scale(y)
			.orient("left");

		var line = d3.svg.line()
			.x(function(d) { return line_x(d[0]); })
			.y(function(d) { return y(d[1]); });

		var svg = d3.select("body").append("div")
			.attr("class", "container line_graph")
		  .append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		    .append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		svg.append("g")
		  .attr("class", "x axis")
		  .attr("transform", "translate(0," + height + ")")
		  .call(xAxis);

	  $('.line_graph .tick')[0].remove()

		svg.append("g")
		  .attr("class", "y axis")
		  .call(yAxis)
		  .append("text")
		  .attr("transform", "rotate(-90)")
		  .attr("y", 6)
		  .attr("dy", ".71em")
		  .style("text-anchor", "end")
		  .text("Number of Articles");
		  
		var day = svg.selectAll(".day")
		  .data(days)
		  .enter().append("g")
		  .attr("class", "day");

		day.append("path")
		  .datum(function(d) { return d;  })
		  .attr("class", "line")
		  .attr("id", function(d) { return color.domain()[days.indexOf(d)]; })
		  .attr("d", line)
		  .on("mouseover", hover)
		  .on("mouseout", exit)
		  .on("click", click)
		  .style("stroke-width", "4")
		  .style("stroke", function(d) { return color(color.domain()[days.indexOf(d)]); });
		
		function hover(d) {
			var id = color.domain()[days.indexOf(d)];
			var path = d3.select("#"+id);
			path.style("stroke", "black");
		}
		
		function exit(d) {
			var id = color.domain()[days.indexOf(d)];
			var path = d3.select("#"+id);
			path.style("stroke", color(color.domain()[days.indexOf(d)]));
		}
		
		var clicked = false;
		var top5 = new Array();
		
		function click(d) {
			if(clicked) d3.select("#bar").remove();

			clicked = true;
			var id = color.domain()[days.indexOf(d)];
			data = document.getElementById(id+"_csv").value;
			data = data.split("\n");
			data.splice(0,2);
			data.splice(-1,1);

			data.sort(function(a,b) {
				a = a.split(",");
				a = parseInt(a[1]);
				b = b.split(",");
				b = parseInt(b[1]);
				if (a > b) return -1;
				else if (a == b) return 0;
				else return 1;
			});

			$('.back_but').fadeIn();
			$('.line_graph').fadeOut();
			draw_scatter(id);
			
			top5 = data.splice(0,5);
			for(var i=0; i < top5.length; i++) {
				top5[i] = top5[i].split(",");
			}

			var side = d3.select("body").append("div")
				.attr("class", "container")
				.attr("id", "bar");
			side.append("h2")
				.text("Top Posts for "+id[0].toUpperCase() + id.slice(1) + " by Points");
			var bar = side.append("svg")
				.attr("class", "chart")
				.attr("width", 300)
				.attr("height", 20 * 5);

			var side2 = d3.select("body").append("div")
				.attr("class", "container hidden back_but")
				.text("Back")
				.on("click",function(){$('.scatter_plot').fadeOut();$('.line_graph').fadeIn();$('.chart').fadeOut();$('#bar').fadeOut();$('.back_but').fadeOut();$('.back_but').remove()})
			
			var x = d3.scale.linear()
				.domain([0, d3.max(top5, function(d) { return d[1]; })])
				.range([0, 300]);
			
			bar.selectAll("rect")
				.data(top5)
			  .enter().append("rect")
				.attr("y", function(d, i) { return i * 20; })
				.attr("width", function(d) { return x(d[1]); })
				.attr("height", 20)
				.attr("id", function(d, i) { return i; })
				.on("mouseover", barHover)
				.on("mouseout", barExit)
				.on("click", barclick);
				
		}
		
		function barclick(d) {
			var url = d[2];
			var win=window.open(url, '_blank');
			win.focus();
		}
		
		function barHover(d) {
			var id = top5.indexOf(d);

			var tooltip = d3.select("#bar").append("div")
				.attr("id", "tooltip")
				.attr("width", 300);
			
			tooltip.append("h3")
				.text("\""+d[0]+"\"");
			tooltip.append("p")
				.text("Points: "+d[1]);
		}
		
		function barExit(d) {
			d3.select("#tooltip").remove();
		}
	</script>	
	


	</body>
</html>